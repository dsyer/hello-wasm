<html>

<head>
	<style>
		.error {
			color: red;
		}

		.guess {
			margin: 12px;
		}

		.tile {
			padding: 4px;
			margin: 6px;
			border: 0px;
			justify-content: center;
			align-items: center;
			font-family: monospace;
			text-transform: uppercase;
		}

		.letter-0 {
			background-color: white;
		}

		.letter-1 {
			background-color: grey;
		}

		.letter-2 {
			background-color: yellow;
		}

		.letter-4 {
			background-color: greenyellow;
		}
	</style>
	<script src="wordle.js"></script>
</head>

<body>

	<br/>

	<div>Word guessing game with logic implemented in C and deployed as a WebAssembly (<a href="https://github.com/dsyer/hello-wasm">source code</a>).</div>
	
	<br/>

	<div>Type a 5-letter word and hit "Enter".</div>

	<br/>

	<div id="guesses"></div>
	<div id="errors" class="error"></div>
	<div>
		<input id="guess" type="text" />
		<button onclick="submit()">Enter</button>
	</div>
	<div>
		<div id="letters" class="guess"></div>
		<div id="solution"></div>
		<button onclick="giveup()">Give Up</button>
	</div>

	<script>
		const encoder = new TextEncoder();
		const decoder = new TextDecoder();
		var alphabet = "abcdefghijklmnopqrstuvwxyz";

		let guess = function (value) {
			const buffer = new Uint8Array(wasmMemory.buffer, 0, value.length);
			buffer.set(encoder.encode(value), 0);
			_guess(buffer, buffer.length);
			var result = [];
			for (i = 0; i < buffer.length; i++) {
				result[i] = buffer[i];
				buffer[i] = 0;
			}
			return result;
		}

		let solution = function () {
			const buffer = new Uint8Array(wasmMemory.buffer, 0, 5);
			_solution(buffer, buffer.length);
			result = decoder.decode(buffer);
			for (i = 0; i < buffer.length; i++) {
				buffer[i] = 0;
			}
			return result;
		}

		let mark = function (value) {
			var result = guess(value);
			var node = document.createElement('div');
			var score = 0;
			node.classList.add("guess")
			for (i = 0; i < result.length && i < value.length; i++) {
				var span = document.createElement('span');
				score = score + result[i];
				span.classList.add("letter-" + result[i], "tile");
				span.innerHTML = value.charAt(i);
				node.appendChild(span);
			}
			return node;
		}

		let handler = function (value) {
			var guesses = document.getElementById("guesses");
			guesses.appendChild(mark(value));
		}

		let giveup = function () {
			var guesses = document.getElementById("solution");
			guesses.appendChild(mark(solution()));
		}

		let cheat = function () {
			var letters = document.getElementById("letters");
			var guesses = document.getElementById("alphabet");
			letters.replaceChild(mark(alphabet), guesses);
		}

		let validate = function (value) {
			const buffer = new Uint8Array(wasmMemory.buffer, 0, value.length);
			buffer.set(encoder.encode(value), 0);
			result = _validate(buffer, buffer.length) > 0;
			for (i=0; i<buffer.length; i++) {
				buffer[i] = 0;
			}
			return result;
		}

		let submit = function () {
			if (!calledMain) {
				window.setTimeout(submit(), 500);
			} else {
				var guess = document.getElementById("guess");
				var errors = document.getElementById("errors");
				var value = guess.value.toLowerCase();
				if (validate(value)) {
					handler(value);
					guess.value = "";
					errors.innerHTML = "";
				} else {
					errors.innerHTML = "Not a word";
				}
				return false;
			}
		}

		window.addEventListener("load", event => {
			var guess = document.getElementById("guess");
			guess.addEventListener("keypress", event => {
				var key = event.which || event.keyCode || 0;
				if (key === 13) {
					submit();
				}
			});
			var letters = document.getElementById("letters");
			var node = document.createElement('div');
			node.id = "alphabet";
			for (i = 0; i < alphabet.length; i++) {
				var span = document.createElement('span');
				span.id = "letter-" + alphabet.charAt(i);
				span.classList.add("letter-0", "tile");
				span.innerHTML = alphabet.charAt(i);
				node.appendChild(span);
			}
			letters.appendChild(node);
		});
	</script>

</body>

</html>